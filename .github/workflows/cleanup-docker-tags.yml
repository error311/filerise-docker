name: Cleanup old Docker Hub tags

# Run once a week (Sunday at 3:00 AM), and also manually via workflow_dispatch
on:
  schedule:
    - cron: '0 3 * * 0'
  workflow_dispatch:

jobs:
  prune:
    runs-on: ubuntu-latest

    steps:
      - name: Login to Docker Hub and get token
        id: login
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          TOKEN=$(curl -s -H "Content-Type: application/json" \
            -X POST -d '{"username":"'"${{ secrets.DOCKER_USERNAME }}"'","password":"'"${{ secrets.DOCKER_PASSWORD }}"'"}' \
            https://hub.docker.com/v2/users/login/ | jq -r .token)
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Delete tags older than 15 days
        env:
          DOCKERHUB_TOKEN: ${{ steps.login.outputs.token }}
        run: |
          set -euo pipefail

          REPO="error311/filerise-docker"

          # threshold timestamp 15 days ago, in UTC ISO‑8601
          THRESHOLD=$(date -u -d '15 days ago' +%Y-%m-%dT%H:%M:%SZ)
          echo "Threshold for deletion: $THRESHOLD"

          PAGE=1
          while :; do
            echo "Fetching page $PAGE of tags…"
            JSON=$(curl -s -H "Authorization: JWT $DOCKERHUB_TOKEN" \
              "https://hub.docker.com/v2/repositories/$REPO/tags/?page=$PAGE&page_size=100")
            COUNT=$(echo "$JSON" | jq '.results | length')
            echo "  → $COUNT tags on this page"

            # select tag names older than threshold, but skip 'latest'
            TAGS=$(echo "$JSON" | jq -r \
              '.results[] 
               | select(.name!="latest" and (.last_updated // empty) < "'"$THRESHOLD"'")
               | .name')

            if [[ -z "$TAGS" ]]; then
              echo "  → no tags older than 15 days on page $PAGE"
            else
              echo "  → will delete these tags:"
              echo "$TAGS" | sed 's/^/    - /'
              for tag in $TAGS; do
                echo "Deleting $REPO:$tag"
                curl -s -X DELETE \
                  -H "Authorization: JWT $DOCKERHUB_TOKEN" \
                  "https://hub.docker.com/v2/repositories/$REPO/tags/$tag/"
              done
            fi

            [[ $COUNT -lt 100 ]] && break
            ((PAGE++))
          done